---
date: 2024-11-16
category:
  - web
tag:
  - brower
---

# 资源预加载

## CSS

### `<link rel="preload">`

- 用途: 声明式地预加载关键资源（如脚本、样式、字体等），优先级优先于页面渲染流程加载资源。
- 特点:
  - 浏览器会优先加载指定资源，但不会自动执行或应用（需手动处理）。
  - 支持 as 属性指定资源类型（如 script、style、font 等），帮助浏览器优化加载策略。
  - 可通过 onload 事件处理加载完成后的逻辑。

```html
<link rel="preload" href="critical.js" as="script">
```

### `<link rel="prefetch">`

- 用途: 预加载未来可能需要的资源（如用户可能跳转的下一页资源），优先级较低。
- 特点:
  - 浏览器会在空闲时加载资源，不阻塞当前页面渲染。
  - 适用于提前加载非首屏但可能用到的资源（如分页内容、模态框组件）。

```html
<link rel="prefetch" href="next-page.js" as="script">
```

### `<link rel="preconnect">` 和 `<link rel="dns-prefetch">`

- 用途: 提前建立与第三方域名的连接，减少跨域资源的加载延迟。
- 区别:
  - `dns-prefetch`：仅提前解析 DNS（将域名转换为 IP 地址）。
  - `preconnect`：不仅解析 DNS，还会建立 TCP 连接（若为 HTTPS 则包括 TLS 握手），优化更彻底。

### `<link rel="prerender">`

- 用途: 预加载并渲染整个页面（包括 DOM、CSS、JS 等），用户跳转时可直接显示。
- 特点:
  - 资源消耗较高，适用于高概率访问的页面（如首页、热门页）
  - 部分浏览器可能限制其使用（如 Chrome 对频繁滥用的页面会禁用）。

```html
<link rel="prerender" href="/home">
```

### 动态创建DOM元素预加载

- 用途: 通过 JavaScript 动态创建 `<script>`、`<link>` 等标签，手动触发资源加载。
- 特点:
  - 灵活性高，可根据用户行为（如滚动、点击）动态决定是否预加载。
  - 需注意避免阻塞主线程。

### Service Worker 预缓存

- 用途: 通过 Service Worker 拦截网络请求，在页面加载前预缓存指定资源（结合 PWA 技术）
- 特点:
  - 支持离线访问，资源可从缓存直接读取，大幅提升二次加载速度。
  - 需配合 workbox 等工具简化实现。

```js
// sw.js
import { precacheAndRoute } from 'workbox-precaching';
precacheAndRoute(self.__WB_MANIFEST); // 预缓存构建时生成的资源列表
```

### CSS 预加载（@import 或 font-display）

- 用途: 针对字体等资源，通过 CSS 策略优化加载。
  - `@import`：在 CSS 中提前引入资源（但可能阻塞渲染，慎用）。
  - `font-display: swap`：字体加载期间先显示 fallback 文本，避免 FOIT（不可见文本闪烁）。

## 选择建议

- 首屏关键资源（如核心 JS/CSS）：用 `preload`。
- 未来可能访问的资源：用 `prefetch`。
- 跨域资源：优先 `preconnect` 或 `dns-prefetch`。
- 整页预渲染：谨慎使用 `prerender`，避免资源浪费。
- 离线支持或复杂缓存策略：用 `Service Worker`。
